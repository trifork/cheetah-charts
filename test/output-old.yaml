---
# Source: redpanda-console-oauth2proxy/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
automountServiceAccountToken: true
metadata:
  name: my-test-redpanda-console-oauth2proxy
  labels:
    helm.sh/chart: redpanda-console-oauth2proxy-1.4.0
    app.kubernetes.io/name: redpanda-console-oauth2proxy
    app.kubernetes.io/instance: my-test
    app.kubernetes.io/version: "v2.8.5"
    app.kubernetes.io/managed-by: Helm
---
# Source: redpanda-console-oauth2proxy/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-test-redpanda-console-oauth2proxy
  labels:
    helm.sh/chart: redpanda-console-oauth2proxy-1.4.0
    app.kubernetes.io/name: redpanda-console-oauth2proxy
    app.kubernetes.io/instance: my-test
    app.kubernetes.io/version: "v2.8.5"
    app.kubernetes.io/managed-by: Helm
    
type: Opaque
data:
  # Set empty defaults, so that we can always mount them as env variable even if they are not used.
  # For this reason we can't use `with` to change the scope.
  # Kafka
  kafka-sasl-password: ""
  kafka-protobuf-git-basicauth-password: ""
  kafka-sasl-aws-msk-iam-secret-key: ""
  kafka-tls-ca: ""
  kafka-tls-cert: ""
  kafka-tls-key: ""
  kafka-schema-registry-password: ""
  kafka-schemaregistry-tls-ca: ""
  kafka-schemaregistry-tls-cert: ""
  kafka-schemaregistry-tls-key: ""

  # Login
  login-jwt-secret: "N3llakdkc0FPelp0dXFFU0hSOVR4cDhGclFLS0h1V3M="
  login-google-oauth-client-secret: ""
  login-google-groups-service-account.json: ""
  login-github-oauth-client-secret: ""
  login-github-personal-access-token: ""
  login-okta-client-secret: ""
  login-okta-directory-api-token: ""
  login-oidc-client-secret: ""

  # Enterprise
  enterprise-license: ""

  # Redpanda
  redpanda-admin-api-password: ""
  redpanda-admin-api-tls-ca: ""
  redpanda-admin-api-tls-cert: ""
  redpanda-admin-api-tls-key: ""
---
# Source: redpanda-console-oauth2proxy/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-test-redpanda-console-oauth2proxy
  labels:
    helm.sh/chart: redpanda-console-oauth2proxy-1.4.0
    app.kubernetes.io/name: redpanda-console-oauth2proxy
    app.kubernetes.io/instance: my-test
    app.kubernetes.io/version: "v2.8.5"
    app.kubernetes.io/managed-by: Helm
    
data:
  config.yaml: |
    # from .Values.console.config
    analytics:
      enabled: false
    kafka:
      brokers: []
      sasl:
        enabled: true
        mechanism: OAUTHBEARER
        oauth: {}
      schemaRegistry:
        enabled: true
        urls: []
---
# Source: redpanda-console-oauth2proxy/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-test-redpanda-console-oauth2proxy
  labels:
    helm.sh/chart: redpanda-console-oauth2proxy-1.4.0
    app.kubernetes.io/name: redpanda-console-oauth2proxy
    app.kubernetes.io/instance: my-test
    app.kubernetes.io/version: "v2.8.5"
    app.kubernetes.io/managed-by: Helm
    
spec:
  type: ClusterIP
  ports:
    - port: 4180
      targetPort: 4180
      appProtocol: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: redpanda-console-oauth2proxy
    app.kubernetes.io/instance: my-test
---
# Source: redpanda-console-oauth2proxy/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-test-redpanda-console-oauth2proxy
  labels:
    helm.sh/chart: redpanda-console-oauth2proxy-1.4.0
    app.kubernetes.io/name: redpanda-console-oauth2proxy
    app.kubernetes.io/instance: my-test
    app.kubernetes.io/version: "v2.8.5"
    app.kubernetes.io/managed-by: Helm
    
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: redpanda-console-oauth2proxy
      app.kubernetes.io/instance: my-test
  template:
    metadata:
      annotations:
        checksum/config: a9c8f3ea83c1ae83b0272af39cc3d3a2d04c86c96353860be60e5f2834aa73eb
      labels:
        app.kubernetes.io/name: redpanda-console-oauth2proxy
        app.kubernetes.io/instance: my-test
    spec:
      serviceAccountName: my-test-redpanda-console-oauth2proxy
      automountServiceAccountToken: true
      securityContext:
        fsGroup: 99
        runAsUser: 99
        seccompProfile:
          type: RuntimeDefault
      volumes:
        - name: configs
          configMap:
            name: my-test-redpanda-console-oauth2proxy
        - name: secrets
          secret:
            secretName: my-test-redpanda-console-oauth2proxy
      containers:
        - name: redpanda-console-oauth2proxy
          args:
            - "--config.filepath=/etc/console/configs/config.yaml"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
          image: docker.redpanda.com/redpandadata/console:v2.8.10
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          volumeMounts:
            - name: configs
              mountPath: /etc/console/configs
              readOnly: true
            - name: secrets
              mountPath: /etc/console/secrets
              readOnly: true
          livenessProbe:
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
            httpGet:
              path: /admin/health
              port: http
          readinessProbe:
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
            httpGet:
              path: /admin/health
              port: http
          resources:
            limits:
              memory: 64Mi
            requests:
              cpu: 5m
              memory: 16Mi
          env:
            - name: LOGIN_JWTSECRET
              valueFrom:
                secretKeyRef:
                  name: my-test-redpanda-console-oauth2proxy
                  key: login-jwt-secret
        - name: oauth2-proxy
          image: quay.io/oauth2-proxy/oauth2-proxy:v7.12.0
          imagePullPolicy: Always
          args:
            - --oidc-issuer-url=
            - --upstream=http://127.0.0.1:8080
            - --reverse-proxy=true
            - --email-domain=*
            - --cookie-secure=true
            # remove Username from audit log, to prevent PII in logs: https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview/#auth-log-format
            - --auth-logging-format=" -  - [] [] "
            - --cookie-name=__Host-_oauth2Proxy
            - --provider=oidc
            - --http-address=0.0.0.0:4180
            - --exclude-logging-path="/ping"
          readinessProbe:
            httpGet:
              path: /ping
              port: http-proxy
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /ping
              port: http-proxy
            initialDelaySeconds: 5
            periodSeconds: 5
          securityContext:
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          ports:
            - containerPort: 4180
              protocol: TCP
              name: http-proxy
          env:
            - name: OAUTH2_PROXY_COOKIE_SECRET
              valueFrom:
                secretKeyRef:
                  key: cookie-secret
                  name: redpanda-oauth2-proxy
            - name: OAUTH2_PROXY_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  key: client-id
                  name: redpanda-oauth2-proxy
            - name: OAUTH2_PROXY_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  key: OAUTH2_PROXY_CLIENT_SECRET
                  name: redpanda-oauth2-proxy
      priorityClassName:
